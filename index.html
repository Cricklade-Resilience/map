<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cricklade Resilience</title>

  <!-- Leaflet CSS for map rendering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- FontAwesome for map icons (e.g. bed, box, shop) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* Ensure full-page map */
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    /* FontAwesome icon styling */
    .fa-icon {
      font-size: 24px;
      color: blue;
      text-shadow: 0 0 2px white;
    }

    /* Geolocation locate button */
    .locate-button {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 1000;
      background-color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 18px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }
    .locate-button:hover { background-color: #f0f0f0; }

    /* Popup image style */
    .popup-image {
      max-width: 100px;
      max-height: 75px;
      margin-top: 5px;
      border-radius: 4px;
      object-fit: contain;
    }

    /* Responsive images for small screens */
    @media (max-width: 768px) {
      .popup-image {
        max-width: 180px;
        max-height: 135px;
      }
    }

    /* Color-coded labels for point features */
    .point-label-red, .point-label-green, .point-label-orange,
    .point-label-blue, .point-label-brown {
      font-weight: bold;
      background: white;
      border-radius: 4px;
      padding: 2px 4px;
      border: 1px solid #ccc;
    }
    .point-label-red { color: red; }
    .point-label-green { color: green; }
    .point-label-orange { color: orange; }
    .point-label-blue { color: blue; }
    .point-label-brown { color: brown; }

    /* Labels for polygon layers like Warden Zones */
    .polygon-label {
      font-weight: bold;
      color: black;
      background: white;
      padding: 2px 6px;
      border: 1px solid #999;
      border-radius: 3px;
      font-size: 12px;
      pointer-events: none;
    }

    /* Info box that pops up when clicking the ‚ìò button */
    .info-box {
      position: absolute;
      bottom: 60px;
      left: 10px;
      width: 300px;
      background: white;
      border: 1px solid #999;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 15px;
      z-index: 1100;
      font-family: sans-serif;
    }

    .info-box h3 { margin-top: 0; }
    .info-box button {
      margin-top: 10px;
      background: #eee;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .info-box button:hover { background: #ddd; }
  </style>
</head>

<body>
<!-- Leaflet map container -->
<div id="map"></div>

<!-- Locate Me button (bottom right) -->
<button onclick="locateUser()" class="locate-button">
  <i class="fa-solid fa-location-crosshairs"></i>
</button>

<!-- Info popup (bottom left) -->
<div id="infoBox" class="info-box" style="display: none;">
  <h3>Cricklade Resilience Map</h3>
  <img src="Images/CrickladeLogo.png" alt="Cricklade" style="width:50px;height:100px;">
  <p>This map helps residents and responders understand flood risks, evacuation sites, and key infrastructure.</p>
  <p>
    <a href="https://example.com/document1.pdf" target="_blank">üìÑ Emergency Plan (PDF)</a><br>
    <a href="https://example.com/document2" target="_blank">üåê Visit our Website</a>
  </p>
  <button onclick="closeInfoBox()">Close</button>
</div>

<!-- Leaflet library -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MAIN SCRIPT -->
<script>
/* -------------------------------
   Initial map setup
--------------------------------- */
const map = L.map('map').setView([51.6409, -1.8577], 14);

// Basemap options
const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CartoDB', subdomains: 'abcd', maxZoom: 19
}).addTo(map);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '¬© OpenStreetMap contributors'
});

const esriAerial = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles ¬© Esri'
});

// Basemap control
const baseMaps = {
  "Greyscale (Carto)": cartoLight,
  "OpenStreetMap": osm,
  "Aerial (Esri)": esriAerial
};

/* -------------------------------
   WMS overlays for flood zones
--------------------------------- */
const floodZone3WMS = L.tileLayer.wms("https://environment.data.gov.uk/spatialdata/flood-map-for-planning-rivers-and-sea-flood-zone-3/wms", {
  layers: "Flood_Map_for_Planning_Rivers_and_Sea_Flood_Zone_3",
  format: "image/png", transparent: true, attribution: "¬© Environment Agency"
});

const floodZone2WMS = L.tileLayer.wms("https://environment.data.gov.uk/spatialdata/flood-map-for-planning-rivers-and-sea-flood-zone-2/wms", {
  layers: "Flood_Map_for_Planning_Rivers_and_Sea_Flood_Zone_2",
  format: "image/png", transparent: true, attribution: "¬© Environment Agency"
});

/* -------------------------------
   Custom icons (FontAwesome)
--------------------------------- */
const faShopIcon = L.divIcon({ html: '<i class="fa-solid fa-shop" style="color: orange;"></i>', className: 'fa-icon', iconSize: [24, 24] });
const WILD =        L.divIcon({ html: '<i class="fa-solid fa-diamond" style="color: blue;"></i>', className: 'fa-icon', iconSize: [24, 24] });
const shelter =     L.divIcon({ html: '<i class="fa-solid fa-bed" style="color: green;"></i>', className: 'fa-icon', iconSize: [24, 24] });
const storage =     L.divIcon({ html: '<i class="fa-solid fa-boxes-packing" style="color: brown;"></i>', className: 'fa-icon', iconSize: [24, 24] });
const medical =     L.divIcon({ html: '<i class="fa-solid fa-house-medical" style="color: red;"></i>', className: 'fa-icon', iconSize: [24, 24] });
const guage =       L.divIcon({ html: '<i class="fa-solid fa-gauge" style="color: blue;"></i>', className: 'fa-icon', iconSize: [24, 24] });
const histflood =   L.divIcon({ html: '<i class="fa-solid fa-star" style="color: blue;"></i>', className: 'fa-icon', iconSize: [24, 24] });

/* -------------------------------
   Load GeoJSON Layers
--------------------------------- */

// Map to hold the loaded GeoJSON overlays
const overlayBuffer = new Map();    // All layers get stored here before adding to map
const overlays = {};                // What gets passed to layer control
const loadPromises = [];            // To track async loading of GeoJSON
const polygonLabels = new Map();    // Polygon tooltips

// Function for custom styling, labels, and popups per feature
function createOnEachFeature(name, icon, label) {
  return function(feature, layerInstance) {
    const props = feature.properties || {};
    const geometryType = feature.geometry.type;
    feature.properties.layerName = name;

    // For Point features: add popup and label
    if (geometryType === "Point") {
      // ... handles popup and tooltip
    }

    // For Polygon features: add tooltip and style
    if ((geometryType === "Polygon" || geometryType === "MultiPolygon") && label) {
      // ... handles polygon center labels
    }

    // Style for polygon outlines
    if (geometryType.includes("Polygon")) {
      // ... handles outline color/opacity
    }
  };
}

// List of layers to load from GeoJSON
const layersToLoad = [
  { name: "Flood: WILD Watercourse Issues", file: "Data/Flood_WILD_Watercourse_Issues.geojson", icon: WILD, label: false },
  { name: "Feature: Medical", file: "Data/Features_Medical.geojson", icon: medical, label: true },
  { name: "Feature: Shelter", file: "Data/Features_Shelter.geojson", icon: shelter, label: true },
  { name: "Feature: Storage", file: "Data/Features_Storage.geojson", icon: storage, label: true },
  { name: "Feature: Supplies", file: "Data/Features_Supplies.geojson", icon: faShopIcon, label: true },
  { name: "Flood: Water Guages", file: "Data/Water_WaterGuages.geojson", icon: guage, label: true },
  { name: "Flood: Areas of Concern", file: "Data/Flood_HistAreas.geojson", icon: histflood, label: true },
  { name: "Admin: Warden Zones", file: "Data/CrickladeWardenZones.geojson", icon: null, label: true },
  { name: "Feature: Evacuation Sites", file: "Data/Features_EvacSites.geojson", icon: null, label: true },
  { name: "Admin: Parish Boundary", file: "Data/Admin_ParishBoundary.geojson", icon: null, label: false }
];

// Load all GeoJSON layers
layersToLoad.forEach(({ name, file, icon, label }) => {
  // Create GeoJSON layer with handlers
  const layer = L.geoJSON(null, {
    pointToLayer: (f, latlng) => icon ? L.marker(latlng, { icon }) : L.marker(latlng),
    onEachFeature: createOnEachFeature(name, icon, label)
  });

  // Load and store layer data
  const p = fetch(file).then(res => res.json()).then(data => {
    data.features.forEach(f => f.properties.layerName = name);
    layer.addData(data);
    if (name === "Admin: Warden Zones" && polygonLabels.has(name)) {
      polygonLabels.get(name).forEach(t => map.addLayer(t));
    }
    overlayBuffer.set(name, layer);
  }).catch(err => console.error(`Error loading ${file}:`, err));

  loadPromises.push(p);
});

/* After all layers are loaded: Add layer control and defaults */
Promise.all(loadPromises).then(() => {
  // Add WMS overlays to list
  overlays["Flood: EA Flood Zone 3 (WMS)"] = floodZone3WMS;
  overlays["Flood: EA Flood Zone 2 (WMS)"] = floodZone2WMS;

  // Control layer ordering
  const orderedNames = [
    "Feature: Medical", "Feature: Shelter", "Feature: Storage", "Feature: Supplies",
    "Feature: Evacuation Sites", "Flood: Water Guages", "Flood: Areas of Concern",
    "Flood: WILD Watercourse Issues", "Admin: Warden Zones", "Admin: Parish Boundary"
  ];

  // Add GeoJSON layers to control
  orderedNames.forEach(name => {
    if (overlayBuffer.has(name)) overlays[name] = overlayBuffer.get(name);
  });

  // Show specific layers by default on map load
  if (overlayBuffer.has("Admin: Warden Zones")) {
    const wardenZonesLayer = overlayBuffer.get("Admin: Warden Zones");
    wardenZonesLayer.addTo(map);
    wardenZonesLayer.eachLayer(l => {
      const tooltip = l._tooltipRef;
      if (tooltip) map.addLayer(tooltip);
    });
  }

  if (overlayBuffer.has("Admin: Parish Boundary")) {
    const parishLayer = overlayBuffer.get("Admin: Parish Boundary");
    parishLayer.addTo(map);
  }

  // Label visibility logic
  const labelVisibilityZoom = 15;
  function updateMapDisplay() {
    const zoom = map.getZoom();
    overlayBuffer.forEach(layer => {
      layer.eachLayer(featureLayer => {
        if (featureLayer._tooltipRef) {
          zoom >= labelVisibilityZoom
            ? featureLayer.openTooltip()
            : featureLayer.closeTooltip();
        }
      });
    });
  }

  map.on("zoomend", updateMapDisplay);
  updateMapDisplay();

  // Add layer control UI
  L.control.layers(baseMaps, overlays, { collapsed: window.innerWidth <= 768 }).addTo(map);
});
  
</script>
</body>
</html>
