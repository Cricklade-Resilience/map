<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cricklade Resilience</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0; padding: 0;
    }
    .polygon-label {
      background-color: rgba(255, 255, 255, 0.7);
      padding: 2px 4px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 12px;
      border: 1px solid #ccc;
      white-space: nowrap;
    }
    .point-label-red {
      color: red;
      font-weight: bold;
      background: white;
      border-radius: 4px;
      padding: 2px 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([51.6409, -1.8577], 14);

  // Base layer
  const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap & CartoDB',
    maxZoom: 19
  }).addTo(map);

  // Store overlays here
  const overlayBuffer = new Map();

  // Style function for polygons based on layer name
  function polygonStyle(layerName) {
    switch(layerName) {
      case "Admin: Parish Boundary":
        return {
          color: "black",
          weight: 4,
          fillOpacity: 0
        };
      case "Admin: Warden Zones":
        return {
          color: "darkgrey",
          weight: 2,
          fillOpacity: 0
        };
      case "Feature: Evacuation Sites":
        return {
          color: "red",
          weight: 2,
          fillColor: "red",
          fillOpacity: 0.4
        };
      default:
        // Default polygon style
        return {
          color: "#0000ff",
          weight: 2,
          fillColor: "#0000ff",
          fillOpacity: 0.1
        };
    }
  }

  const layersToLoad = [
    { name: "Admin: Parish Boundary", file: "Data/Admin_ParishBoundary.geojson", icon: null, label: true },
    { name: "Admin: Warden Zones", file: "Data/CrickladeWardenZones.geojson", icon: null, label: true },
    { name: "Feature: Evacuation Sites", file: "Data/Features_EvacSites.geojson", icon: null, label: true }
    // add your other layers here as needed
  ];

  layersToLoad.forEach(({ name, file, icon, label }) => {
    const layer = L.geoJSON(null, {
      style: (feature) => {
        if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
          return polygonStyle(name);
        }
      },
      pointToLayer: icon ? (feature, latlng) => L.marker(latlng, { icon }) : undefined,
      onEachFeature: (feature, layerInstance) => {
        const props = feature.properties || {};
        const nameProp = props.name || "No Name";

        if (feature.geometry.type === "Point") {
          if (label && icon) {
            // Bind permanent tooltip for points
            layerInstance.bindTooltip(nameProp, {
              permanent: true,
              direction: "top",
              offset: [0, -20],
              className: 'point-label-red'  // example, can customize
            });
          }
        } else if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
          if (label) {
            // Calculate centroid for label placement
            const centroid = layerInstance.getBounds().getCenter();
            layerInstance.bindTooltip(nameProp, {
              permanent: true,
              direction: "center",
              className: "polygon-label",
              offset: [0, 0]
            }).setLatLng(centroid);
          }
        }
      }
    });

    fetch(file)
      .then(res => {
        if (!res.ok) throw new Error(`Failed to load ${file}: ${res.statusText}`);
        return res.json();
      })
      .then(data => {
        layer.addData(data);
        overlayBuffer.set(name, layer);
        if (name === "Admin: Warden Zones") {
          layer.addTo(map);  // Add default visible layer
        }
        console.log(`Loaded layer: ${name}`);
      })
      .catch(err => console.error(err));
  });

  // Wait for all layers to load then add layer control
  Promise.all(layersToLoad.map(l => fetch(l.file).then(res => res.json()))).then(() => {
    const overlays = {};
    overlayBuffer.forEach((layer, name) => overlays[name] = layer);

    L.control.layers(null, overlays, { collapsed: false }).addTo(map);
  });
</script>
</body>
</html>


