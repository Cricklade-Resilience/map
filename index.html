<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cricklade Resilience</title>

  <!-- Leaflet CSS for map styling -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* Make map fill the page */
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    /* Style for FontAwesome icons on map */
    .fa-icon {
      font-size: 24px;
      color: blue;
      text-shadow: 0 0 2px white;
    }

    /* Locate button styling */
    .locate-button {
      background-color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 18px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }

    /* Hover effect on locate button */
    .locate-button:hover { background-color: #f0f0f0; }

    /* Position the locate button in bottom right */
    .locate-button {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 1000;
      background-color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 18px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }

    /* Style for images inside popups */
    .popup-image {
      max-width: 100px;
      max-height: 75px;
      margin-top: 5px;
      border-radius: 4px;
      display: block;
      object-fit: contain;
    }

    /* Larger images on smaller screens */
    @media (max-width: 768px) {
      .popup-image {
        max-width: 180px;
        max-height: 135px;
      }
    }

    /* Label styles for different point colors */
    .point-label-red, .point-label-green, .point-label-orange,
    .point-label-blue, .point-label-brown {
      font-weight: bold;
      background: white;
      border-radius: 4px;
      padding: 2px 4px;
      border: 1px solid #ccc;
    }

    .point-label-red { color: red; }
    .point-label-green { color: green; }
    .point-label-orange { color: orange; }
    .point-label-blue { color: blue; }
    .point-label-brown { color: brown; }

    /* Style for polygon labels */
    .polygon-label {
      font-weight: bold;
      color: black;
      background: white;
      padding: 2px 6px;
      border: 1px solid #999;
      border-radius: 3px;
      font-size: 12px;
      pointer-events: none; /* labels don‚Äôt capture mouse events */
    }

    /* Info box styling (bottom left) */
    .info-box {
      position: absolute;
      bottom: 60px;
      left: 10px;
      width: 300px;
      background: white;
      border: 1px solid #999;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 15px;
      z-index: 1100;
      font-family: sans-serif;
    }

    .info-box h3 {
      margin-top: 0;
    }

    /* Buttons inside info box */
    .info-box button {
      margin-top: 10px;
      background: #eee;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .info-box button:hover {
      background: #ddd;
    }
  </style>
</head>
<body>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Button to toggle user location tracking -->
  <button onclick="locateUser()" class="locate-button">
    <i class="fa-solid fa-location-crosshairs"></i>
  </button>

  <!-- Information box initially hidden -->
  <div id="infoBox" class="info-box" style="display: none;">
    <h3>Cricklade Resilience Map</h3>
    <img src="Images/CrickladeLogo.png" alt="Cricklade" style="width:50px;height:100px;">
    <p>This map helps residents and responders understand flood risks, evacuation sites, and key infrastructure.</p>
    <p>
      <a href="https://example.com/document1.pdf" target="_blank">üìÑ Emergency Plan (PDF)</a><br>
      <a href="https://example.com/document2" target="_blank">üåê Visit our Website</a>
    </p>
    <button onclick="closeInfoBox()">Close</button>
  </div>

  <!-- Leaflet JS library -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Initialize the map centered on Cricklade
    const map = L.map('map').setView([51.6409, -1.8577], 14);

    // Define base map layers
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);  // Add Carto greyscale as default

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '¬© OpenStreetMap contributors'
    });

    const esriAerial = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri'
    });

    // Base maps object for layer control
    const baseMaps = {
      "Greyscale (Carto)": cartoLight,
      "OpenStreetMap": osm,
      "Aerial (Esri)": esriAerial
    };

    // WMS flood zone overlays from Environment Agency
    const floodZone3WMS = L.tileLayer.wms("https://environment.data.gov.uk/spatialdata/flood-map-for-planning-rivers-and-sea-flood-zone-3/wms", {
      layers: "Flood_Map_for_Planning_Rivers_and_Sea_Flood_Zone_3",
      format: "image/png", transparent: true, attribution: "¬© Environment Agency"
    });

    const floodZone2WMS = L.tileLayer.wms("https://environment.data.gov.uk/spatialdata/flood-map-for-planning-rivers-and-sea-flood-zone-2/wms", {
      layers: "Flood_Map_for_Planning_Rivers_and_Sea_Flood_Zone_2",
      format: "image/png", transparent: true, attribution: "¬© Environment Agency"
    });

    // Define various icons for different feature types using FontAwesome icons
    const faShopIcon = L.divIcon({ html: '<i class="fa-solid fa-shop" style="color: orange;"></i>', className: 'fa-icon', iconSize: [24, 24] });
    const WILD = L.divIcon({ html: '<i class="fa-solid fa-diamond" style="color: blue;"></i>', className: 'fa-icon', iconSize: [24, 24] });
    const shelter = L.divIcon({ html: '<i class="fa-solid fa-bed" style="color: green;"></i>', className: 'fa-icon', iconSize: [24, 24] });
    const storage = L.divIcon({ html: '<i class="fa-solid fa-boxes-packing" style="color: brown;"></i>', className: 'fa-icon', iconSize: [24, 24] });
    const medical = L.divIcon({ html: '<i class="fa-solid fa-house-medical" style="color: red;"></i>', className: 'fa-icon', iconSize: [24, 24] });
    const guage = L.divIcon({ html: '<i class="fa-solid fa-gauge" style="color: blue;"></i>', className: 'fa-icon', iconSize: [24, 24] });
    const histflood = L.divIcon({ html: '<i class="fa-solid fa-star" style="color: blue;"></i>', className: 'fa-icon', iconSize: [24, 24] });

    // Storage for layers before adding to map controls
    const overlayBuffer = new Map();
    const overlays = {};
    const loadPromises = [];
    const polygonLabels = new Map();

    // Function to create popup and tooltip on each GeoJSON feature
    function createOnEachFeature(name, icon, label) {
      return function(feature, layerInstance) {
        const props = feature.properties || {};
        const geometryType = feature.geometry.type;
        feature.properties.layerName = name;  // Track layer name in properties

        // For Point features: add popup and optional label tooltip
        if (geometryType === "Point") {
          const nameProp = props.name || "Unknown";
          const type = props.type || "";
          const description = props.description || "";
          let popupContent = `<strong>${nameProp}</strong><br>${description}`;

          // Append photo if available
          if (props.photo) {
            popupContent += `<br><img src="${props.photo}" alt="${nameProp}" class="popup-image" />`;
          }

          // Bind popup to the marker
          layerInstance.bindPopup(popupContent);

          // Add a tooltip label if label parameter is true
          if (label) {
            const labelClass = `point-label-${label}`;
            layerInstance.bindTooltip(nameProp, {
              permanent: true,
              direction: 'right',
              className: labelClass,
              offset: [10, 0]
            });
          }

          // Set icon for the marker if provided
          if (icon) layerInstance.setIcon(icon);
        } 
        else if (geometryType === "Polygon" || geometryType === "MultiPolygon") {
          // For polygons, add popup and a label marker in the centroid

          let popupContent = `<strong>${props.name || "Area"}</strong><br>${props.description || ""}`;

          // Bind popup to polygon
          layerInstance.bindPopup(popupContent);

          // Compute polygon centroid for label
          let centroid = null;
          if (geometryType === "Polygon") {
            centroid = getPolygonCentroid(feature.geometry.coordinates[0]);
          } else if (geometryType === "MultiPolygon") {
            // Just use the first polygon for centroid
            centroid = getPolygonCentroid(feature.geometry.coordinates[0][0]);
          }

          if (centroid) {
            // Create a non-interactive label marker at centroid
            const labelMarker = L.marker([centroid[1], centroid[0]], {
              icon: L.divIcon({
                className: 'polygon-label',
                html: props.name || "Area",
                iconSize: null
              }),
              interactive: false
            }).addTo(map);

            polygonLabels.set(layerInstance, labelMarker);
          }
        }
      };
    }

    // Calculate centroid of polygon coordinates
    function getPolygonCentroid(coords) {
      let area = 0, x = 0, y = 0;
      for (let i = 0, j = coords.length - 1; i < coords.length; j = i++) {
        let p1 = coords[i];
        let p2 = coords[j];
        let f = p1[0] * p2[1] - p2[0] * p1[1];
        area += f;
        x += (p1[0] + p2[0]) * f;
        y += (p1[1] + p2[1]) * f;
      }
      area /= 2;
      x /= (6 * area);
      y /= (6 * area);
      return [x, y];
    }

    // Add a new GeoJSON layer and store it for layer control
    function addLayer(name, url, icon, label) {
      // Fetch GeoJSON data
      const promise = fetch(url)
        .then(response => response.json())
        .then(data => {
          // Create GeoJSON layer with popups and icons
          const layer = L.geoJSON(data, {
            onEachFeature: createOnEachFeature(name, icon, label)
          });

          // Add to buffer map for overlays and layer control
          overlayBuffer.set(name, layer);
          overlays[name] = layer;
        }).catch(err => {
          console.error(`Failed to load layer ${name} from ${url}:`, err);
        });

      loadPromises.push(promise);
    }

    // URLs for GeoJSON layers ‚Äî replace with your real URLs
    addLayer("Flood Warning Areas", "https://gist.githubusercontent.com/cmc2468/12bb1ff4663e54809c335cc352bce132/raw/floodwarningareas.geojson", null, false);
    addLayer("Emergency Assembly Points", "https://gist.githubusercontent.com/cmc2468/d2614e865cc4d677f5bdb8d58ec1d6e2/raw/emergencyassemblypoints.geojson", faShopIcon, "orange");
    addLayer("Flood History", "https://gist.githubusercontent.com/cmc2468/0b65e259a969d9b9df53cc538f7a8320/raw/historicalflood.geojson", histflood, "blue");
    addLayer("Evacuation Points", "https://gist.githubusercontent.com/cmc2468/531f78f15df3dbf09a13db16b3d8e09d/raw/evacuationpoints.geojson", shelter, "green");
    addLayer("Storage", "https://gist.githubusercontent.com/cmc2468/8573c5e21b206dbb84e4764328a4ac43/raw/storage.geojson", storage, "brown");
    addLayer("Medical", "https://gist.githubusercontent.com/cmc2468/3d23d0d7922ef2a3eb9833ed15439d01/raw/medical.geojson", medical, "red");
    addLayer("Flood Gauges", "https://gist.githubusercontent.com/cmc2468/30ed7f35b492efeb3e5c236ee465302c/raw/floodgauges.geojson", guage, "blue");

    // Wait for all GeoJSON layers to load before adding controls and overlays
    Promise.all(loadPromises).then(() => {
      // Add all overlay layers to the map by default
      for (const [name, layer] of overlayBuffer.entries()) {
        layer.addTo(map);
      }

      // Add flood zone WMS overlays (off by default)
      overlays["Flood Zone 2"] = floodZone2WMS;
      overlays["Flood Zone 3"] = floodZone3WMS;

      // Add layer control to map
      L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);
    });

    // Function to toggle user geolocation tracking
    let locateOn = false;
    let userLocationMarker;

    function locateUser() {
      if (!locateOn) {
        // Start locating user
        map.locate({ setView: true, watch: true, maxZoom: 17 });
        locateOn = true;
      } else {
        // Stop locating user
        map.stopLocate();
        locateOn = false;
        if (userLocationMarker) {
          map.removeLayer(userLocationMarker);
          userLocationMarker = null;
        }
      }
    }

    // Handle location found event
    map.on('locationfound', function(e) {
      if (!userLocationMarker) {
        userLocationMarker = L.marker(e.latlng).addTo(map);
        userLocationMarker.bindPopup("You are here").openPopup();
      } else {
        userLocationMarker.setLatLng(e.latlng);
      }
    });

    // Handle location error event
    map.on('locationerror', function(e) {
      alert("Location access denied.");
    });

    // Info box functions
    function showInfoBox() {
      document.getElementById('infoBox').style.display = 'block';
    }

    function closeInfoBox() {
      document.getElementById('infoBox').style.display = 'none';
    }

    // Show info box when page loads
    window.onload = () => {
      showInfoBox();
    };
  </script>

</body>
</html>
